<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="manifest" href="canvasdraw.webmanifest" />
		<title>Canvas Draw</title>
		<style>
			body {
				margin: 0 auto;
				overflow: hidden;
			}
			
			#canvas {
				border: solid 1px black;
				position: relative;
			}
		</style>
		<script>    
			var canvas, ctx, ball;
			var touches = [];
			
			var Ball = function(){
				this.lineWidth = 5;
				this.left;
				this.top;
			};

			Ball.prototype.render = function(){
				ctx.lineWidth = this.lineWidth;
				ctx.strokeStyle = 'darkorange';
				ctx.lineCap = 'round';
				ctx.lineTo(this.left, this.top);
				ctx.stroke();
			};

			var update = function(){
				ball.render();
				localStorage.setItem('img', canvas.toDataURL());
				requestAnimationFrame(update);
			};
			
			var load = function(){
				canvas = document.getElementById('canvas');  
				if (canvas.getContext) {  
					ctx = canvas.getContext('2d');
					ball = new Ball();

					if(localStorage.getItem('img')){
						var img = new Image();
						img.addEventListener('load', function(e){
							ctx.drawImage(img, 0, 0);
						}, false);
						img.src = localStorage.getItem('img');
					}

					document.getElementById('btnclear').addEventListener('click', function(){
						localStorage.clear();
						ctx.clearRect(0, 0, canvas.width, canvas.height);
					}, false);

					canvas.addEventListener('touchmove', ontouchmove);

					canvas.addEventListener('touchstart', function(e) {
						ctx.beginPath();
						touches = e.touches;
					});
				}
				requestAnimationFrame(update);
			};
			
			var ontouchmove = function(e){
				e.preventDefault();
				touch = e.touches[0];
				ball.left = touch.pageX;
				ball.top = touch.pageY;
			};

			var loadServiceWorker = e => {
				if ('serviceWorker' in navigator) {
					navigator.serviceWorker.register('/sw.js', { scope: '/' }).then( reg => {
						if(reg.installing) {
							console.log('Service worker installing');
						} else if(reg.waiting) {
							console.log('Service worker installed');
						} else if(reg.active) {
							console.log('Service worker active');
						}

					}).catch(error => {
						// registration failed
						console.log('Registration failed with ' + error);
						});
				}
			};
			
			document.addEventListener('DOMContentLoaded', loadServiceWorker, false);
			document.addEventListener('DOMContentLoaded', load, false);
		</script>  
	</head>
	<body>
		<canvas id="canvas" width="400" height="400"></canvas> 
		<div>
			<button id="btnclear">Clear</button>	
		</div>
	</body>
</html>